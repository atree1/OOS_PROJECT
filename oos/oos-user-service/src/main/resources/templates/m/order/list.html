<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{/m/layout/shopLayout}">
	<div class="container" style="margin-top: 20px;"
	layout:fragment="container">
	<div class="card">
              <div class="card-header">
                <h3 class="card-title">#INV0015</h3>
                <div class="card-options">
                  <button type="button" class="btn btn-primary" onclick="javascript:window.print();"><i class="si si-printer"></i> Print Invoice</button>
                </div>
              </div>
              <div class="card-body">
              	주문 정보 확인
                <div class="table-responsive push">
                  <table class="table table-bordered table-hover">
                    <tbody><tr>
                      <th>Product</th>
                      <th class="text-center" style="width: 10%; min-width:60px;">수량</th>
                      <th class="text-right" style="width: 10%; min-width:60px;">가격</th>
                    </tr>
                    <tr th:each="arr: ${orderList}">
                      
                      <td>
                        <img th:class="|thumb_${arr.pno}|"
													style="width: 60px; display: inline-block; vertical-align: middle;">
                        <p class="font-w600 mb-1" th:text="${arr.product.pname}">PNAME</p>
                        <div class="text-muted" th:text="|사이즈 / ${arr.option.size}|">SIZE</div>
                      </td>
                      <td class="text-center" th:text="${arr.qty}">
                        QTY
                      </td>
                      <td class="text-right"
                     	th:id="|price_${arr.opno}|"
						th:class="|sumPrice pno_${arr.product.pno}|"
						th:data-price="${arr.product.price*arr.qty}"
						th:text="${arr.product.price*arr.qty}">PRICE</td>
                    </tr>
                   
                    <tr>
                      <td colspan="2" class="font-w600 text-right">물픔 금액</td>
                      <td class="text-right">
                      	<span class="d_goodsSumPrice"></span>원</td>
                    </tr>
                    <tr>
                      <td colspan="2" class="font-w600 text-right">배송비</td>
                      <td class="text-right">3000원</td>
                    </tr>
                    <tr>
                      <td colspan="2" class="font-weight-bold text-uppercase text-right">총 주문금액</td>
                      <td class="font-weight-bold text-right">
                      	<span class="d_totalPrice">0</span>원</td>
                    </tr>
                  </tbody></table>
                </div>
               </div>
           </div>
	</div>
	
<th:block layout:fragment="script">
<script th:inline="javascript" 
		src="http://dmaps.daum.net/map_js_init/postcode.v2.js?autoload=false"></script>
	<script th:inline="javascript">
	$(document).ready(function(){
		var token = $("meta[name='_csrf']").attr("content");
		var header = $("meta[name='_csrf_header']").attr("content");
		
	    var orderList = [[${orderList}]];
	    var list = new Array();
		var member = [[${#authentication.principal.member}]];
		var tel = member.pnum;
		var totalCount = $(".optionPrice").data("price");
		var sum = 0;
		(function(){
			
			getTotalSum();
			
			$.each(orderList, function(index, item){
				var sum = 0;
				
				$.makeArray($(".sumPrice").map(function(){
					if($(this).hasClass("pno_"+item.pno)){
						sum += $(this).data("price");
					}
					
				}));
				 
				var img =  item.product.imgList[0];
				
				var fileCallPath =  encodeURIComponent(img.ipath+ "/s_"+ img.uuid +"_"+img.iname);
				
				$.each($('.thumb_'+ item.pno),function(){
					$(this).attr("src","/display?fileName="+fileCallPath); 
				});
				 
				$("#sumText_"+item.pno).html(sum);
				
			});
			
			if(tel.substring(1,3) == "10"){
				$("#pnum").val("010").prop("selected",true);
			}if(tel.substring(1,3) == "11"){
				$("#pnum").val("011").prop("selected",true);
			}if(tel.substring(1,3) == "16"){
				$("#pnum").val("011").prop("selected",true);
			}if(tel.substring(1,3) == "19"){
				$("#pnum").val("019").prop("selected",true);
			}
			
			$("#pnum2").val(tel.substring(3,7));
			$("#pnum3").val(tel.substring(7));
			
		})();


		$(".adressSearch").click(function(){
			daum.postcode.load(function(){
		        new daum.Postcode({
		            oncomplete: function(data) {
		            	address(data);
		            }
		        }).open();
		    });
		});
		
		function address(data){
			$("#roadAddr1").val(data.postcode);
			$("#roadAddr2").val(data.roadAddress);
			$("#roadAddr3").val("");
		}
		
		$(".orderBtn").on('click',function(e){
			e.preventDefault();
			$.each(orderList, function(index, item){
				
				var json = { 
						pno: item.pno,
						mid : member.mid,
						product: item.product,
						qty: item.qty,
						opno: item.opno,
						qty: item.qty,
						sno: item.sno,
						name:  $("#orderName").val(),
						address: $("#roadAddr2").val(),
						addressDetail: $("#roadAddr3").val(),
						pnum: $("#pnum option:selected").val()+$("#pnum2").val()+$("#pnum3").val()
				}
				
				list.push(json);
				
			});		
			

			console.log(list);
			 $.ajax({
                type:"post",
                data : JSON.stringify(list),
                url: "/kakaopay/pay",
                contentType : "application/json; charset=UTF-8",
                success:function(result, status, xhr){
                	popupOpen(result);
    			}
            }); 
			 
		});
		
	function popupOpen(popUrl){

		var popOption = "width=400, height=500, resizable=no, scrollbars=no, status=no;";    //팝업창 옵션(optoin)
		window.open(popUrl,"",popOption);
	
	}

	 function getTotalSum(){
		$.makeArray($(".sumPrice").map(function(){
			sum += $(this).data("price");
		}));
		$(".d_goodsSumPrice").html(sum);
		$(".d_totalPrice").html(sum + 3000);
	}
		
	
	});
	</script>
</th:block>	
</html>