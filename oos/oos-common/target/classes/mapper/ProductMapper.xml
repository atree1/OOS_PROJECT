<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.oos.mapper.ProductMapper">
	<resultMap type="org.oos.domain.CategoryVO" id="Category">
		<result column="cateno" property="cateno" />
		<result column="catename" property="catename" />
	</resultMap>
	<resultMap type="org.oos.domain.ProductOptionVO" id="Option">
		<result column="opno" property="opno" />
		<result column="size" property="size" />
		<result column="qty" property="qty" />
	</resultMap>
	<resultMap type="org.oos.domain.ProductImgVO" id="Image">
		<result column="uuid" property="uuid" />
		<result column="pno" property="pno"/>
		<result column="iname" property="iname" />
		<result column="ipath" property="ipath" />
	</resultMap>
	<resultMap type="org.oos.domain.ProductVO" id="Product">
		<result column="pno" property="pno" />
		<result column="pname" property="pname" />
		<result column="price" property="price" />
		<result column="sname" property="sname" />
		<result column="sno" property="sno" />
		<result column="regdate" property="regdate" />
		<result column="updatedate" property="updatedate" />
		<result column="del" property="del" />
		<result column="questionreplycnt" property="questionReplyCnt" />
		<result column="reviewreplycnt" property="reviewReplyCnt" />
		<result column="content" property="content" />
		<collection property="imgList" resultMap="Image" />
		<collection property="optList" resultMap="Option" />
		<collection property="cateList" resultMap="Category" />
	</resultMap>

	<select id="getByPno" resultMap="Product">
		select * from tbl_product p left join tbl_product_img i
		on p.pno =i.pno left join tbl_product_option o on p.pno=o.pno
		where p.pno=#{pno}
	</select>
	
	<select id="getList2" parameterType="map" resultMap="Product">
		select product.pno,product.pname
		,product.price,product.sno,product.regdate,product.updatedate,product.del,product.uuid,product.iname,product.ipath
		,s.sname from
		(
		select
			 p.pno ,p.pname,p.price,p.sno,p.regdate,p.updatedate,del,uuid,iname,ipath 
		from
			tbl_product p left join tbl_product_img i
			on p.pno =i.pno left join tbl_product_option o on p.pno=o.pno
			where p.pno>0
			    group by p.pno
		)product join tbl_store s
			on s.sno = product.sno
		 where s.sno > 0	
		<if test="sno != null">
			and s.sno=#{sno}
		</if>
		<if test="dto.cri.category != null">
			and product.pname like concat("%", #{dto.cri.keyword} ,"%")
		</if>
		<choose>
			<when test="dto.cri.orderby == '1'.toString()">
				order by product.price desc
			</when>
			<when test="dto.cri.orderby == '2'.toString()">
				order by product.price asc
			</when>
			<otherwise>
				order by product.pno desc
			</otherwise>
		</choose>
		limit #{dto.cri.skip} ,#{dto.cri.amount}
	</select>
	
	<select id="bestProductList" resultType="org.oos.domain.ProductVO" resultMap="Product">
		<![CDATA[
		select cateno, catename, c.pno, b.pname, b.price, b.uuid, b.ipath, b.iname from tbl_category c
		join(select d.pno, pname, price, uuid, ipath, iname, count(*) cnt from tbl_order_detail d
			join(select p.pno, pname, price, uuid, ipath, iname from tbl_product p
					join(select * from tbl_product_img
						 where uuid != "" group by pno) i
					on i.pno = p.pno
					where p.pno > 0 and del = 'N') pr
			on pr.pno = d.pno                    
			where odno > 0 and del = 'N'
			and to_days(now()) - to_days(d.regdate) <= 7
			group by d.pno) b
		on c.pno =  b.pno
		where cateno > 0 and del = 'N'
		]]>
		<if test="cateno != null">
			and cateno = ${cateno}
		</if>
		order by cateno asc, cnt desc
		limit 0, 6
	</select>
	
	<!-- <select id="getList" parameterType="map" resultMap="Product">
		select p.pno, p.pname, price, sname, p.del, s.sno ,p.regdate
		from
		tbl_product p join tbl_store s
		on s.sno = p.sno left join
		tbl_product_img i
		on p.pno =i.pno left join tbl_product_option o on p.pno=o.pno
		where
		p.pno>0
		<if test="sno != null">
			and s.sno=#{sno}
		</if>
		<if test="dto.cri.category != null">
			and p.pname like concat("%", #{dto.cri.keyword} ,"%")
		</if>
		<choose>
			<when test="dto.cri.orderby == '1'.toString()">
				order by price desc
			</when>
			<when test="dto.cri.orderby == '2'.toString()">
				order by price asc
			</when>
			<otherwise>
				order by pno desc
			</otherwise>
		</choose>
		limit #{dto.cri.skip} ,#{dto.cri.amount}
	</select> -->

	<select id="get" resultType="org.oos.domain.ProductVO">
		select *
		from tbl_product
		where
		pno=#{pno}
	</select>

	<insert id="insert">
		insert into tbl_product(pname,price,sno,content)
		values(#{pname},#{price},#{sno},#{content})
		<selectKey resultType="Long" keyProperty="pno" order="AFTER">
			select max(pno) from tbl_product
		</selectKey>
	</insert>

	<update id="modify">
		update tbl_product
		set pname=#{pname},price=#{price},content=#{content}
		where pno=#{pno}
	</update>
	
	<update id="delete">
		update tbl_product
		set del='Y'
		where pno=${pno}
	</update>

	<select id="count" parameterType="map" resultType="int">
		select count(*)
		from tbl_product
		where pno > 0
		<if test="sno != null">
			and sno=#{sno}
		</if>
		<if test="cri != null and cri.category != null">
			and pname like concat("%", #{cri.keyword} ,"%")
		</if>
	</select>

	<select id="getName" resultType="string">
		select pname from tbl_product
		where pno>0
	</select>
	
<<<<<<< HEAD
=======
	<select id="bestProductList" resultType="org.oos.domain.ProductVO" resultMap="Product">
		<![CDATA[
		select * from (select * from tbl_product_img
						where pno > 0 group by pno) i
		join(select p.pno, p.pname, p.price, p.sno, d.cnt, d.regdate from tbl_product p
			join (select pno, count(*) cnt, regdate from tbl_order_detail
					where del = 'N' and pno > 0 group by pno ) d
			where d.pno = p.pno and p.del = 'N' and d.pno > 0
			and to_days(now()) - to_days(d.regdate) <= 7) p
		where p.pno = i.pno and p.pno > 0
		order by cnt desc
		limit 0, 5
		]]>
	</select>
	
>>>>>>> branch 'master' of https://github.com/atree1/OOS_PROJECT.git
	<update id="updateQuestionReplyCnt">
		update tbl_product set questionreplycnt = questionreplycnt + #{amount}
		where pno = #{pno}
	</update>

	<update id="updateReviewReplyCnt">
		update tbl_product set reviewreplycnt = reviewreplycnt + #{amount}
		where pno = #{pno}
	</update>
</mapper>